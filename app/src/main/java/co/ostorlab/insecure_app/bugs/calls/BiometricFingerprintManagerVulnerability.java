package co.ostorlab.insecure_app.bugs.calls;

import android.app.AlertDialog;
import android.content.Context;
import android.content.DialogInterface;
import android.hardware.fingerprint.FingerprintManager;
import android.os.CancellationSignal;
import android.widget.Toast;

import co.ostorlab.insecure_app.BugRule;

public final class BiometricFingerprintManagerVulnerability extends BugRule {

    @Override
    public void run(String user_input) throws Exception {
        Context context = getContext();
//        The class FingerprintManager
        FingerprintManager fingerprintManager = (FingerprintManager) context.getSystemService(Context.FINGERPRINT_SERVICE);
        CancellationSignal cancellationSignal = new CancellationSignal();

        FingerprintManager.AuthenticationCallback authenticationCallback = new FingerprintManager.AuthenticationCallback() {
            @Override
            public void onAuthenticationError(int errorCode, CharSequence errString) {
                Toast.makeText(context, "Authentication error: " + errString, Toast.LENGTH_LONG).show();
            }
            @Override
            public void onAuthenticationFailed() {
                Toast.makeText(context, "Authentication failed", Toast.LENGTH_LONG).show();
            }
            @Override
            public void onAuthenticationSucceeded(FingerprintManager.AuthenticationResult result) {
                Toast.makeText(context, "Authentication succeeded", Toast.LENGTH_LONG).show();
                showSuccessAlert(context);
            }
        };

        fingerprintManager.authenticate(null, cancellationSignal, 0, authenticationCallback, null);
    }

    @Override
    public String getDescription() {
        return "Biometric Fingerprint Manager Vulnerability";
    }

    private static void showSuccessAlert(Context context) {
        new AlertDialog.Builder(context)
                .setTitle("Success")
                .setMessage("Login succeeded!")
                .setPositiveButton("OK", new DialogInterface.OnClickListener() {
                    public void onClick(DialogInterface dialog, int whichButton) {
                        dialog.dismiss();
                    }
                }).show();
    }
}
